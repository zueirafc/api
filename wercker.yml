box: ruby:2.3
services:
  - postgres
build:
  steps:
    - script:
        name: bundle config
        code: bundle config build.nokogiri --use-system-libraries

    - internal/store-container
    - bundle-install
    - rails-database-yml

    - script:
        name: Set up db
        code: bundle exec rake db:schema:load RAILS_ENV=test

    - script:
        name: RSpec
        code: bundle exec rspec

    - script:
        name: Rubocop (static code analyzer)
        code: bundle exec rubocop -D

deploy:
    steps:
      - heroku-deploy:
          key-name: DEPLOYMENT_KEY
          install-toolbelt: true
          retry: true
          run: rake db:migrate --app $HEROKU_APP_NAME
